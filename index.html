<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compounding Trading Plan Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Dark Theme and Animations */
        :root {
            --primary-color: #34d399; /* Emerald-400 for accent */
            --secondary-color: #60a5fa; /* Blue-400 for solve button */
            --background-dark: #111827; /* Deep Navy */
            --card-dark: #1f2937; /* Dark Slate */
            --input-dark: #374151; /* Medium Gray */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: #d1d5db; /* Light Gray Text */
            transition: background-color 0.5s;
        }
        .card {
            background-color: var(--card-dark);
            border: 1px solid #374151; /* Subtle border */
        }
        .input-field {
            transition: all 0.3s ease-in-out;
            background-color: var(--input-dark);
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); /* Emerald glow */
            border-color: var(--primary-color);
        }
        
        /* Table Styles */
        .plan-table th, .plan-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #374151;
            font-size: 0.8rem; /* Make text slightly smaller for more columns */
        }
        .plan-table th {
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
        }
        .plan-table tbody tr:hover {
            background-color: rgba(52, 211, 153, 0.05);
        }
        
        /* Highlight cells for high risk */
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2); /* Red-500 20% opacity */
            color: #fca5a5; /* Red-300 text */
            font-weight: bold;
        }

        /* Calculated Result Styles (Emerald Theme) */
        .calculated-summary {
            background-color: rgba(52, 211, 153, 0.1); /* Emerald-400 10% opacity */
            border-color: rgba(52, 211, 153, 0.3);
            color: var(--primary-color);
        }

        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #explanation-container {
            background-color: rgba(96, 165, 250, 0.1); /* Blue-400 */
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        /* Animation for "Model by prince Collins," */
        @keyframes slideInFromLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .moving-text {
            display: inline-block;
            animation: slideInFromLeft 1.5s ease-out forwards;
            color: var(--secondary-color); /* Highlight color */
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="card w-full max-w-6xl p-6 sm:p-10 rounded-2xl shadow-2xl">

        <!-- Title and Description -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight">
                XAUUSD Compounding Trading Plan Generator (Pro)
            </h1>
            <p class="mt-2 text-gray-400">
                <span class="moving-text">Model by prince Collins,</span>
            </p>
        </header>

        <!-- Input Form -->
        <div id="calculator-form">
            <h3 class="text-lg font-semibold text-gray-200 mb-4">Plan Inputs (Specific to XAUUSD):</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                
                <!-- 1. Principal (P) -->
                <div class="flex flex-col">
                    <label for="p" class="text-sm font-medium text-gray-300 mb-1">Initial Capital ($)</label>
                    <input type="number" id="p" class="input-field p-3 rounded-xl focus:ring-secondary-color">
                </div>

                <!-- 2. Rate (r) -->
                <div class="flex flex-col">
                    <label for="r" class="text-sm font-medium text-gray-300 mb-1">Target Daily Rate (%)</label>
                    <input type="number" id="r" class="input-field p-3 rounded-xl focus:ring-secondary-color" step="0.1">
                </div>
                
                <!-- 3. Number of Periods (n) -->
                <div class="flex flex-col">
                    <label for="n" class="text-sm font-medium text-gray-300 mb-1">Number of Days (n)</label>
                    <input type="number" id="n" class="input-field p-3 rounded-xl focus:ring-secondary-color">
                </div>
                
                <!-- 4. Leverage -->
                <div class="flex flex-col">
                    <label for="leverage" class="text-sm font-medium text-gray-300 mb-1">Leverage Ratio</label>
                    <input type="number" id="leverage" class="input-field p-3 rounded-xl focus:ring-secondary-color">
                </div>
                
            </div>

            <!-- Solve Button -->
            <button onclick="calculateSequence()" class="mt-8 w-full bg-secondary-color text-white font-bold py-3 rounded-xl hover:bg-blue-500 transition duration-300 shadow-xl shadow-blue-500/30 active:scale-[0.98] transform">
                Generate XAUUSD Daily Plan
            </button>
        </div>

        <!-- Result and Error Container -->
        <div id="result-container" class="mt-8 pt-6 border-t border-gray-700">
            <!-- Error Message Box -->
            <div id="error-message" class="hidden p-4 rounded-xl font-medium transition duration-300"></div>

            <!-- Results Panel -->
            <div id="results-panel" class="hidden">
                <h2 class="text-xl font-bold text-gray-100 mb-5 text-center">Plan Summary and Daily Breakdown</h2>
                
                <!-- Summary Metrics (Final Value, Total Profit, and System Trading Parameters) -->
                <div id="summary-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <!-- Metrics injected here -->
                </div>

                <!-- Daily Plan Table Container -->
                <div class="overflow-x-auto shadow-2xl rounded-xl border border-gray-700">
                    <table class="plan-table w-full">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Start Capital</th>
                                <th>Target Profit ($)</th>
                                <th>Lot Size</th>
                                <th>Required Margin ($)</th>
                                <th>Used Margin (%)</th>
                                <th>TP Per Trade (Points)</th>
                                <th>End Capital</th>
                            </tr>
                        </thead>
                        <tbody id="daily-plan-table-body">
                            <!-- Daily plan rows injected here -->
                        </tbody>
                    </table>
                </div>

                <!-- Gemini Explanation Feature -->
                <button onclick="generateExplanation()" id="explain-button" class="mt-6 w-full bg-primary-color text-gray-900 font-bold py-3 rounded-xl hover:bg-emerald-500 transition duration-300 shadow-xl shadow-emerald-500/30 active:scale-[0.98] transform flex items-center justify-center space-x-2">
                    <span class="text-xl">ðŸ“ˆ</span> <span>Explain This XAUUSD Plan</span>
                </button>
                <div id="explanation-container" class="mt-6 p-4 rounded-xl hidden">
                    <div id="explanation-content" class="text-gray-300"></div>
                    <div id="loading-spinner" class="text-center flex items-center justify-center space-x-3 py-2 hidden">
                        <div class="spinner"></div>
                        <span class="text-primary-color font-medium">Analyzing compounding growth and XAUUSD risk requirements...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state for solved sequence parameters
        let currentSequence = {}; 
        
        // System-Determined Conservative Trading Targets (Fixed)
        const DEFAULT_TOTAL_POINTS = 25; // Total points/units target for the day 
        const DEFAULT_NUM_TRADES = 5;  // Number of trades to achieve the points target
        
        // Trading Constants specific to XAUUSD (Gold)
        const XAUUSD_CONTRACT_SIZE = 100; 
        const VALUE_PER_STANDARD_LOT_PER_POINT = 10; 

        // Fixed Price for Margin Calculation (since the input field was removed)
        const XAUUSD_PRICE_FIXED = 4000; // Updated from 2000 to 4000

        // API Configuration
        const apiKey = ""; // Canvas will automatically provide this key at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // Global utility to safely convert input to a number or null
        const getNum = (id) => {
            const element = document.getElementById(id); 
            if (!element) return null; 
            const value = element.value;
            return value === "" ? null : parseFloat(value);
        };

        // Utility function to format numbers (financial/trading focus)
        const formatNumber = (num, type) => {
            if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return 'N/A';
            
            if (type === 'currency') {
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                }).format(num);
            } else if (type === 'lot') {
                 // Lot sizes are typically handled to 2 decimal places (0.01 micro lot minimum)
                return num.toFixed(2);
            } else if (type === 'points' || type === 'percent') {
                return num.toFixed(1);
            }
            // Default to integer
            return Math.round(num).toString();
        };

        // Utility function for exponential backoff retry logic
        async function callGemini(payload, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate explanation.";

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }

        // Function to set the error message
        const showErrorMessage = (message) => {
            const errorMessageElement = document.getElementById('error-message');
            errorMessageElement.textContent = `Error: ${message}`;
            errorMessageElement.classList.remove('hidden');
            errorMessageElement.classList.add('bg-red-900/50', 'text-red-300'); // Apply error styling
        };

        // Function to perform the calculation and update the UI
        function calculateSequence() {
            // User Inputs
            let P = getNum('p');                    // Initial Capital
            let r_percent = getNum('r');            // Rate (Daily Compound Rate)
            let n = getNum('n');                    // Number of Periods (Days)
            let L = getNum('leverage');             // Leverage Ratio (e.g., 100)
            
            // Fixed XAUUSD Price for Margin Calculation
            const XAUUSD_price = XAUUSD_PRICE_FIXED; 
            
            // System-Determined Trading Parameters
            let T_points = DEFAULT_TOTAL_POINTS;
            let N_trades = DEFAULT_NUM_TRADES;
            
            const requiredInputs = [P, r_percent, n, L];
            
            const resultsPanel = document.getElementById('results-panel');
            const tableBody = document.getElementById('daily-plan-table-body');
            const errorMessage = document.getElementById('error-message');
            const explanationContainer = document.getElementById('explanation-container');

            // Reset UI
            errorMessage.classList.add('hidden');
            resultsPanel.classList.add('hidden');
            tableBody.innerHTML = '';
            explanationContainer.classList.add('hidden');
            document.getElementById('summary-metrics').innerHTML = '';


            // --- Input Validation ---
            if (requiredInputs.some(val => val === null || isNaN(val))) {
                showErrorMessage('All four input fields must be filled with valid numbers.');
                return;
            }

            if (P <= 0 || r_percent <= 0 || n <= 0 || L <= 0) {
                showErrorMessage('All input values must be positive and greater than zero.');
                return;
            }
            if (!Number.isInteger(n) || !Number.isInteger(L)) {
                 showErrorMessage('Number of Days and Leverage Ratio must be whole numbers (integers).');
                 return;
            }
            if (r_percent > 100) {
                showErrorMessage('Target Daily Rate cannot exceed 100%.');
                return;
            }

            // Convert percentage to decimal rate (r)
            const r = r_percent / 100;

            // Calculate TP in Points per Trade (Fixed for all days)
            const TP_points_per_trade = T_points / N_trades;

            // --- Iterative Calculation Logic ---
            let currentCapital = P;
            let dailyPlan = [];
            let A = P; // Final value placeholder
            let riskTooHigh = false;

            try {
                for (let k = 1; k <= n; k++) {
                    const startCapital = currentCapital;
                    
                    // 1. Calculate Target Daily Profit ($)
                    const targetProfit = startCapital * r;

                    // 2. Calculate Required Lot Size (in standard lots)
                    // Lot Size = Target Profit / (Total Points * Value per Standard Lot per Point)
                    const requiredLotSize = targetProfit / (T_points * VALUE_PER_STANDARD_LOT_PER_POINT);
                    
                    // 3. Calculate Required Margin ($) (XAUUSD Specific)
                    // Notional Value = Lot Size * Contract Size (100 oz) * Price
                    // Required Margin = Notional Value / Leverage Ratio
                    const notionalValue = requiredLotSize * XAUUSD_CONTRACT_SIZE * XAUUSD_price;
                    const requiredMargin = notionalValue / L;
                    
                    // 4. Calculate Used Margin Percentage
                    const usedMarginPercent = (requiredMargin / startCapital) * 100;

                    // 5. Check Risk (Flag if > 10% used margin) - Professional threshold
                    if (usedMarginPercent > 10) {
                        riskTooHigh = true;
                    }
                    
                    // 6. Calculate End Capital
                    const endCapital = startCapital + targetProfit;
                    
                    dailyPlan.push({
                        day: k,
                        startCapital: startCapital,
                        targetProfit: targetProfit,
                        requiredLotSize: requiredLotSize,
                        requiredMargin: requiredMargin,
                        usedMarginPercent: usedMarginPercent,
                        tpPointsPerTrade: TP_points_per_trade,
                        endCapital: endCapital,
                        riskFlag: usedMarginPercent > 10 
                    });

                    // Update capital for the next day's calculation
                    currentCapital = endCapital;
                    A = endCapital; // A is the final capital on the last day
                }

                const finalProfit = A - P;

                // --- Store and Render Summary ---
                currentSequence = { P, r_percent, n, L, XAUUSD_price, T_points, N_trades, finalProfit, A, dailyPlan, TP_points_per_trade, riskTooHigh }; 
                
                const summaryMetricsHtml = `
                    <div class="calculated-summary p-4 rounded-xl flex flex-col shadow-xl">
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Final Projected Value</span>
                        <span class="text-xl font-extrabold mt-1">$${formatNumber(A, 'currency')}</span>
                    </div>
                    <div class="calculated-summary p-4 rounded-xl flex flex-col shadow-xl">
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">Total Projected Profit</span>
                        <span class="text-xl font-extrabold mt-1">$${formatNumber(finalProfit, 'currency')}</span>
                    </div>
                    <div class="calculated-summary p-4 rounded-xl flex flex-col shadow-xl">
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">System Daily Points Target</span>
                        <span class="text-xl font-extrabold mt-1">${T_points} points</span>
                    </div>
                    <div class="calculated-summary p-4 rounded-xl flex flex-col shadow-xl">
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wider">TP Per Trade (Points)</span>
                        <span class="text-xl font-extrabold mt-1">${formatNumber(TP_points_per_trade, 'points')} points</span>
                    </div>
                `;
                document.getElementById('summary-metrics').innerHTML = summaryMetricsHtml;


                // --- Render Daily Plan Table ---
                let tableHtml = '';
                dailyPlan.forEach((dayData, index) => {
                    const isLastDay = index === dailyPlan.length - 1;
                    const rowClass = isLastDay ? 'font-bold bg-gray-700/50' : '';
                    const riskClass = dayData.riskFlag ? 'risk-high' : '';

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${dayData.day}</td>
                            <td>$${formatNumber(dayData.startCapital, 'currency')}</td>
                            <td>$${formatNumber(dayData.targetProfit, 'currency')}</td>
                            <td>${formatNumber(dayData.requiredLotSize, 'lot')}</td>
                            <td>$${formatNumber(dayData.requiredMargin, 'currency')}</td>
                            <td class="${riskClass}">${formatNumber(dayData.usedMarginPercent, 'percent')}%</td>
                            <td>${formatNumber(dayData.tpPointsPerTrade, 'points')}</td>
                            <td>$${formatNumber(dayData.endCapital, 'currency')}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = tableHtml;
                
                // Show risk warning if necessary
                if (riskTooHigh) {
                    showErrorMessage('WARNING: The required Lot Size on some days is pushing the Used Margin above the conservative 10% threshold. This indicates high leverage risk. For a safer plan, consider lowering your Target Daily Rate or using higher Leverage.');
                }

                resultsPanel.classList.remove('hidden');

            } catch (e) {
                // Handle unexpected runtime calculation errors (like overflow)
                showErrorMessage(`A calculation error occurred: ${e.message}. Please check your inputs, especially high rates or long days.`);
            }
        }
        
        // Function to call the Gemini API for explanation
        async function generateExplanation() {
            const container = document.getElementById('explanation-container');
            const content = document.getElementById('explanation-content');
            const spinner = document.getElementById('loading-spinner');
            const explainButton = document.getElementById('explain-button');

            const { P, r_percent, n, L, XAUUSD_price, T_points, N_trades, finalProfit, A, dailyPlan, TP_points_per_trade, riskTooHigh } = currentSequence; 

            if (!A) {
                content.textContent = "Please generate the trading plan first to generate an explanation.";
                container.classList.remove('hidden');
                return;
            }

            // Show loading state
            container.classList.remove('hidden');
            content.classList.add('hidden');
            spinner.classList.remove('hidden');
            explainButton.disabled = true;

            // Get key data points for the prompt
            const fp = formatNumber(P, 'currency');
            const fa = formatNumber(A, 'currency');
            const fprofit = formatNumber(finalProfit, 'currency');
            const day1Lot = formatNumber(dailyPlan[0].requiredLotSize, 'lot');
            const day1Margin = formatNumber(dailyPlan[0].usedMarginPercent, 'percent');
            const lastDayLot = formatNumber(dailyPlan[dailyPlan.length - 1].requiredLotSize, 'lot');
            const lastDayMargin = formatNumber(dailyPlan[dailyPlan.length - 1].usedMarginPercent, 'percent');

            const riskWarning = riskTooHigh ? 
                "Crucially, explain that the plan enters a high-risk zone where the Used Margin exceeds 10% of the capital on later days due to the combination of leverage and XAUUSD price, requiring caution. Emphasize the need to adjust rate or leverage if this occurs." : 
                "Explain the role of the Used Margin percentage as a key risk metric, demonstrating that margin usage remains stable or low relative to the growing capital, which is crucial for reliability in XAUUSD trading.";


            const userQuery = `Explain the professional compounding trading plan specifically for XAUUSD (Gold) based on these metrics: 
                - Initial Capital: $${fp}
                - Target Daily Increment Rate: ${r_percent}%
                - Total Days: ${n}
                - Leverage Used: 1:${L}
                - XAUUSD Price used for Margin: $${XAUUSD_price} (Fixed for calculation)
                - Fixed Daily Profit Target (based on points): ${T_points} points
                - TP Per Trade (Points): ${formatNumber(TP_points_per_trade, 'points')} points
                - Day 1 Lot Size / Used Margin: ${day1Lot} lots / ${day1Margin}%
                - Final Day Lot Size / Used Margin: ${lastDayLot} lots / ${lastDayMargin}%
                - Final Projected Value: $${fa}

                Explain the required lot size dynamic and the critical importance of the 'Used Margin (%)' column for risk management under the given leverage and the fixed price of Gold. ${riskWarning}`;

            const systemPrompt = "You are a friendly, expert financial analyst focusing on XAUUSD trading. Provide a clear, single paragraph explanation. Describe how the Lot Size must increase daily to hit the fixed percentage target. Crucially, detail the professional XAUUSD margin calculation, explaining that 'Required Margin' is tied to the current Gold price and leverage, making the 'Used Margin (%)' the definitive risk indicator. Emphasize that monitoring this metric is key to reliability and long-term compounding success.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const responseText = await callGemini(payload);
                
                // Add the image tag for the visual aid on exponential growth
                const finalContent = responseText + '<div class="mt-4">[Image of Exponential Gold Price Chart]</div>';

                content.innerHTML = finalContent.replace(/\n/g, '<br>'); // Format newlines for HTML

            } catch (error) {
                content.textContent = `Sorry, I couldn't analyze the compounding effect right now. (${error.message})`;
            } finally {
                // Hide loading state and show content
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
                explainButton.disabled = false;
            }
        }
    </script>
</body>
</html>