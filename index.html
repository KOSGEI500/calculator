<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometric Progression Solver (Compounding Model)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Dark Theme and Animations */
        :root {
            --primary-color: #34d399; /* Emerald-400 for accent */
            --secondary-color: #60a5fa; /* Blue-400 for solve button */
            --background-dark: #111827; /* Deep Navy */
            --card-dark: #1f2937; /* Dark Slate */
            --input-dark: #374151; /* Medium Gray */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: #d1d5db; /* Light Gray Text */
            transition: background-color 0.5s;
        }
        .card {
            background-color: var(--card-dark);
            border: 1px solid #374151; /* Subtle border */
        }
        .input-field {
            transition: all 0.3s ease-in-out;
            background-color: var(--input-dark);
            border: 1px solid #4b5563;
            color: #f3f4f6;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.4); /* Emerald glow */
            border-color: var(--primary-color);
        }
        .result-item {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s;
            transform: translateY(15px);
            opacity: 0;
            cursor: default;
        }
        .result-item.show {
            transform: translateY(0);
            opacity: 1;
        }
        .result-item:hover {
            transform: scale(1.02);
        }

        /* Calculated Result Styles (Emerald Theme) */
        .calculated {
            background-color: rgba(52, 211, 153, 0.1); /* Emerald-400 10% opacity */
            border-color: rgba(52, 211, 153, 0.3);
            color: var(--primary-color);
        }
        /* Known Result Styles (Gray Theme) */
        .known {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }

        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error and Explanation Box styles (kept for runtime errors if they occur, but suppressed for input validation) */
        #error-message {
            background-color: rgba(239, 68, 68, 0.15); /* Red-600 */
            color: #fca5a5; /* Red-300 */
            border: 1px solid #991b1b;
        }
        #explanation-container {
            background-color: rgba(96, 165, 250, 0.1); /* Blue-400 */
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        /* Animation for "Model by prince Collins," */
        @keyframes slideInFromLeft {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        .moving-text {
            display: inline-block;
            animation: slideInFromLeft 1.5s ease-out forwards;
            color: var(--secondary-color); /* Highlight color */
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="card w-full max-w-2xl p-6 sm:p-10 rounded-2xl shadow-2xl">

        <!-- Title and Description -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight">
                Compounding Financial Projection ($A = P(1 + r)^n$)
            </h1>
            <p class="mt-2 text-gray-400">
                <span class="moving-text">Model by prince Collins,</span>
            </p>
        </header>

        <!-- Input Form -->
        <div id="calculator-form">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                
                <!-- Input Field: Principal (P) -->
                <div class="flex flex-col">
                    <label for="p" class="text-sm font-medium text-gray-300 mb-1">Initial Capital (P)</label>
                    <input type="number" id="p" class="input-field p-3 rounded-xl focus:ring-secondary-color">
                </div>

                <!-- Input Field: Rate (r) -->
                <div class="flex flex-col">
                    <label for="r" class="text-sm font-medium text-gray-300 mb-1">Increment Percentage (r, 1-100)</label>
                    <input type="number" id="r" class="input-field p-3 rounded-xl focus:ring-secondary-color" step="0.1">
                </div>
                
                <!-- Input Field: Number of Periods (n) -->
                <div class="flex flex-col">
                    <label for="n" class="text-sm font-medium text-gray-300 mb-1">Number of Days (n)</label>
                    <input type="number" id="n" class="input-field p-3 rounded-xl focus:ring-secondary-color">
                </div>
                
            </div>

            <!-- Solve Button -->
            <button onclick="calculateSequence()" class="mt-8 w-full bg-secondary-color text-white font-bold py-3 rounded-xl hover:bg-blue-500 transition duration-300 shadow-xl shadow-blue-500/30 active:scale-[0.98] transform">
                Calculate Compound Value
            </button>
        </div>

        <!-- Result and Error Container -->
        <div id="result-container" class="mt-8 pt-6 border-t border-gray-700">
            <!-- Error Message Box - Now only used for runtime errors, hidden otherwise -->
            <div id="error-message" class="hidden p-4 rounded-xl font-medium transition duration-300"></div>

            <!-- Results Panel -->
            <div id="results-panel" class="hidden">
                <!-- Title is now explicitly for the Final Value -->
                <h2 class="text-xl font-bold text-gray-100 mb-5 text-center">Final Accumulated Value (Projection)</h2>
                <div class="grid grid-cols-1 gap-4 max-w-sm mx-auto"> <!-- Single column for single output -->
                    <!-- Results will be injected here -->
                </div>

                <!-- Gemini Explanation Feature -->
                <button onclick="generateExplanation()" id="explain-button" class="mt-6 w-full bg-primary-color text-gray-900 font-bold py-3 rounded-xl hover:bg-emerald-500 transition duration-300 shadow-xl shadow-emerald-500/30 active:scale-[0.98] transform flex items-center justify-center space-x-2">
                    <span class="text-xl">ðŸ“ˆ</span> <span>Explain This Compounding Effect</span>
                </button>
                <div id="explanation-container" class="mt-6 p-4 rounded-xl hidden">
                    <div id="explanation-content" class="text-gray-300"></div>
                    <div id="loading-spinner" class="text-center flex items-center justify-center space-x-3 py-2 hidden">
                        <div class="spinner"></div>
                        <span class="text-primary-color font-medium">Analyzing compounding growth and projecting future value...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state for solved sequence parameters
        let currentSequence = {}; 
        const apiKey = ""; // Canvas will automatically provide this key at runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // Global utility to safely convert input to a number or null
        const getNum = (id) => {
            const element = document.getElementById(id); 
            if (!element) return null; // Returns null if the element doesn't exist
            const value = element.value;
            return value === "" ? null : parseFloat(value);
        };

        // Utility function to format numbers with commas
        const formatNumber = (num) => {
            if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return 'N/A';
            
            // Format to use commas as thousand separators, keeping up to 4 decimal places
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2, // Keep 2 decimal places for currency style projection
                maximumFractionDigits: 4 
            }).format(num);
        };

        // Utility function for exponential backoff retry logic
        async function callGemini(payload, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        // Too Many Requests (Rate Limit) - Wait and retry
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate explanation.";

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Re-throw the error on the final attempt
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }


        // Function to perform the calculation and update the UI
        function calculateSequence() {
            // New Variables for Compounding: A = P(1 + r)^n
            let p = getNum('p'); // Principal (Initial Investment)
            let r = getNum('r'); // Rate (Daily Compound Rate) - NOW 1-100
            let n = getNum('n'); // Number of Periods (Days)
            let a = null; // Final Accumulated Value (A)
            
            // Check for the three required inputs: P, r, n
            let known = [p, r, n].filter(val => val !== null).length; 
            
            const errorMessage = document.getElementById('error-message');
            const resultsPanel = document.getElementById('results-panel');
            const resultsGrid = resultsPanel.querySelector('.grid');
            const explanationContainer = document.getElementById('explanation-container');

            // Reset UI and hide error message for a fresh attempt
            errorMessage.classList.add('hidden');
            resultsPanel.classList.add('hidden');
            resultsGrid.innerHTML = '';
            explanationContainer.classList.add('hidden');
            document.getElementById('explanation-content').innerHTML = '';


            // --- Core Constraint Check (3 inputs needed) ---
            if (known !== 3) {
                // Rejects silently (no note on UI), logs to system console
                console.error('Rejection (System Note): Calculation aborted. Not all three required input values (P, r, n) were provided.');
                return; 
            }

            // Additional validation for compounding specific values
            if (p <= 0) {
                // Rejects silently (no note on UI), logs to system console
                console.error('Rejection (System Note): Initial Capital (P) must be greater than zero. Calculation aborted.');
                return;
            }
            
            // VALIDATION: Check if r is between 1 and 100 (inclusive)
            if (r <= 0 || r > 100) {
                // Rejects silently (no note on UI), logs to system console
                console.error('Rejection (System Note): Increment Percentage (r) must be between 1 and 100 (inclusive). Calculation aborted.');
                return; 
            }
            
            if (n <= 0 || !Number.isInteger(n)) {
                // Rejects silently (no note on UI), logs to system console
                console.error('Rejection (System Note): The Number of Days (n) must be a positive integer. Calculation aborted.');
                return;
            }

            // Convert percentage (1-100) to decimal (0.01-1.0) for the formula
            const decimalRate = r / 100;
            
            // --- Solver Logic: A = P(1 + r)^n ---
            try {
                // Calculate Final Accumulated Value (A) using the decimal rate
                a = p * Math.pow(1 + decimalRate, n);
                
                // --- Display Results (Filtered and Formatted) ---
                // Store successful results in global state
                currentSequence = { p, r, n, a }; 
                
                const calculatedOutputs = [
                    { label: "Final Accumulated Value (A)", value: a, id: 'a' },
                ]; 

                calculatedOutputs.forEach((item) => {
                    // Apply comma formatting and currency style
                    let formattedValue = formatNumber(item.value);
                    
                    const resultClass = 'calculated'; 
                    
                    const html = `
                        <div class="result-item p-4 rounded-xl flex flex-col shadow-xl ${resultClass}">
                            <span class="text-sm font-medium text-gray-400">${item.label}</span>
                            <span class="text-2xl font-extrabold mt-1">$${formattedValue}</span>
                            <span class="text-xs font-semibold mt-1">CALCULATED</span>
                        </div>
                    `;
                    resultsGrid.innerHTML += html;
                });

                resultsPanel.classList.remove('hidden');
                
                // Animate results
                const resultItems = resultsGrid.querySelectorAll('.result-item');
                resultItems.forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.add('show');
                    }, 80 * index); // Staggered animation
                });

            } catch (e) {
                // Handle unexpected runtime calculation errors (like overflow)
                console.error(`Runtime Calculation Error: ${e.message}. Please review your inputs.`);
            }
        }
        
        // Function to call the Gemini API for explanation
        async function generateExplanation() {
            const container = document.getElementById('explanation-container');
            const content = document.getElementById('explanation-content');
            const spinner = document.getElementById('loading-spinner');
            const explainButton = document.getElementById('explain-button');

            const { p, r, n, a } = currentSequence; // r is the whole number percentage (1-100)

            // Show loading state
            container.classList.remove('hidden');
            content.classList.add('hidden');
            spinner.classList.remove('hidden');
            explainButton.disabled = true;

            const ratePercent = r.toFixed(2) + '%';
            const decimalRate = r / 100; // Calculate decimal rate for context in the query

            const userQuery = `Explain the following compounding financial scenario in a simple, concise paragraph suitable for an investor: Initial Capital (P): ${p}, Increment Percentage (r): ${ratePercent}, Number of Days (n): ${n}, Final Accumulated Value (A): ${a}. The compounding formula uses the daily decimal rate of ${decimalRate}. Describe the concept of compounding in this context and the final projected value.`;

            const systemPrompt = "You are a friendly, expert financial analyst. Provide a clear, single paragraph explanation of the compounding process, using the provided values (P, R, N, A) to make the concept concrete for an investor. Focus on the 'interest on interest' effect over the specified time period.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const responseText = await callGemini(payload);
                content.innerHTML = responseText.replace(/\n/g, '<br>'); // Format newlines for HTML
            } catch (error) {
                content.textContent = `Sorry, I couldn't analyze the compounding effect right now. (${error.message})`;
            } finally {
                // Hide loading state and show content
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
                explainButton.disabled = false;
            }
        }
    </script>
</body>
</html>

